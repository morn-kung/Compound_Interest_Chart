<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal & Compound Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container {
            max-width: 900px;
        }
        #compoundingChart {
            max-width: 100%;
            height: 400px;
        }
        .tab-button.active {
            @apply border-b-2 border-blue-600 text-blue-600 font-semibold;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-gray-200">
        <!-- User Info Bar -->
        <div id="userInfoBar" class="flex justify-between items-center mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <div>
                <span class="text-sm text-gray-600">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</span>
                <span id="userDisplayName" class="font-semibold text-blue-700 ml-1">Loading...</span>
                <span class="text-xs text-gray-500 ml-2" id="userRole"></span>
            </div>
            <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-600">Balance:</span>
                <span id="currentBalance" class="font-bold text-green-600">$0.00</span>
                <button id="logoutButton" class="text-sm text-red-600 hover:text-red-800 underline">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
        
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700 mb-6 text-center">
            Trading & Compound Interest Planner
        </h1>
        
        <!-- Tab Navigation -->
        <div class="flex border-b mb-6">
            <button id="tab-calculator" class="tab-button active px-4 py-2 text-gray-600 focus:outline-none transition-colors duration-200">
                üöÄ Compound Planner
            </button>
            <button id="tab-recorder" class="tab-button px-4 py-2 text-gray-600 focus:outline-none transition-colors duration-200">
                ‚úçÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </button>
        </div>

        <!-- 1. Compound Calculator Tab Content (Logic remains unchanged) -->
        <div id="content-calculator">
            <p class="text-base sm:text-lg text-gray-600 mb-6 text-center">
                ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô: <span id="initialCapitalDisplay" class="font-semibold text-gray-800">$100</span> | ‡∏Å‡∏≥‡πÑ‡∏£: <span class="font-semibold text-gray-800">1% ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</span>
            </p>
            <p class="text-center text-sm text-gray-500 mb-4">
                ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: <span id="durationDisplay">3 ‡∏õ‡∏µ (1095 ‡∏ß‡∏±‡∏ô)</span>
            </p>
            
            <!-- Input Section for Capital, Year and Exchange Rate -->
            <div class="flex flex-col sm:flex-row items-center justify-center mb-6 space-y-4 sm:space-y-0 sm:space-x-8">
                <div class="flex flex-col items-center">
                    <label for="initialCapitalInput" class="text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (USD):</label>
                    <input type="number" id="initialCapitalInput" value="100" min="100" class="w-24 px-4 py-2 text-center border border-gray-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                    <p id="capitalWarning" class="text-red-500 text-xs mt-1 hidden">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ñ‡∏∑‡∏≠ $100</p>
                </div>
                <div class="flex flex-col items-center">
                    <label for="yearInput" class="text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏õ‡∏µ):</label>
                    <input type="number" id="yearInput" value="3" step="1" min="1" max="5" class="w-24 px-4 py-2 text-center border border-gray-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <div class="flex flex-col items-center">
                    <label for="exchangeRateInput" class="text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (1 USD = ? THB):</label>
                    <input type="number" id="exchangeRateInput" value="31" step="0.01" class="w-24 px-4 py-2 text-center border border-gray-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
            </div>
            
            <!-- Summary Section -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8 text-center">
                <div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                    <p id="summaryInitialCapital" class="text-2xl font-bold text-gray-800">$100.00</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</p>
                    <p id="finalAmount" class="text-2xl font-extrabold text-green-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏ö‡∏≤‡∏ó)</p>
                    <p id="netProfit" class="text-2xl font-bold text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>
                </div>
            </div>

            <div class="w-full mt-6">
                <canvas id="compoundingChart"></canvas>
            </div>
            
            <!-- Tables (Hidden for brevity in this view, retained in JS logic) -->
            <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-200 mt-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1 ‡∏õ‡∏µ)</h2>
                <div class="overflow-x-auto">
                    <table id="yearlySummaryTable" class="min-w-full text-sm text-left text-gray-500 border-collapse">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-center rounded-tl-lg">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th scope="col" class="px-3 py-2 text-right">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (USD)</th>
                                <th scope="col" class="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (USD)</th>
                                <th scope="col" class="px-3 py-2 text-right rounded-tr-lg">‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (USD)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-200 mt-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï 1% ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô)</h2>
                <div class="overflow-x-auto">
                    <table id="dailyTradingTable" class="min-w-full text-sm text-left text-gray-500 border-collapse">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-center rounded-tl-lg">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th scope="col" class="px-3 py-2 text-right">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô (USD)</th>
                                <th scope="col" class="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£ 1% (USD)</th>
                                <th scope="col" class="px-3 py-2 text-right">‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (USD)</th>
                                <th scope="col" class="px-3 py-2 text-center rounded-tr-lg">Lot Size</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 2. Daily Trade Recorder Tab Content -->
        <div id="content-recorder" class="hidden">
            <p class="text-lg text-gray-600 mb-6 text-center">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏ö‡∏ö‡∏ó‡∏ö‡∏ï‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á</p>
            <form id="tradeForm" class="space-y-4">
                
                <!-- Container for multiple dynamic trade entries -->
                <div id="tradeEntriesContainer" class="space-y-6">
                    <!-- Trade Entry Blocks will be dynamically added here -->
                </div>

                <!-- Button to add new entry -->
                <div class="flex justify-start pt-2">
                    <button type="button" id="addEntryButton" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center p-2 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                    </button>
                </div>

                <!-- Status and Submit Button -->
                <div class="flex flex-col items-center space-y-3 pt-4 border-t pt-6 mt-6">
                    <button type="submit" id="submitButton" class="w-full sm:w-1/2 flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <p id="submissionStatus" class="text-sm font-medium hidden p-2 rounded-lg text-center w-full"></p>
                </div>

            </form>
        </div>

        <!-- Menu Navigation (for SPA) -->
        <div id="menuContainer" class="flex space-x-4">
          <button data-menu-id="home" class="menu-button">Home</button>
          <button data-menu-id="oee" class="menu-button">OEE</button>
          <button data-menu-id="login" class="menu-button">Login</button>
        </div>

        <!-- Content Container (for SPA) -->
        <div id="contentContainer" class="mt-4">
          <!-- Dynamic content will be loaded here -->
        </div>

        <!-- Data Table (for SPA) -->
        <table id="dataTable" class="table-auto w-full mt-4">
          <thead>
            <tr>
              <th>Column 1</th>
              <th>Column 2</th>
              <th>Column 3</th>
            </tr>
          </thead>
          <tbody>
            <tr id="balanceRow">
              <td colspan="3">Balance: $0</td>
            </tr>
          </tbody>
        </table>
    </div>
    <script>
        // **********************************************
        // Configuration and Data Mocking (Replace with App Script URLs later)
        // **********************************************
        // ** ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà Deploy ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **
        const APPS_SCRIPT_URL = 'YOUR_DEPLOYED_WEB_APP_URL';
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown)
        const MOCK_ACCOUNTS = [
            { "Account ID": "405911362", "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ": "likit1", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (USD)": "1000" },
            { "Account ID": "107338990", "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ": "mega", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (USD)": "20" }
        ];

        const MOCK_ASSETS = [
            { "Asset ID": "1", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå": "BTC" },
            { "Asset ID": "2", "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå": "XAUU" }
        ];
        
        let entryCounter = 0; // Global counter for unique IDs

        // **********************************************
        // Utility Functions
        // **********************************************

        /**
         * ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠ 0 ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
         * @param {string | null | undefined} value - ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á
         * @returns {number} ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
         */
        function safeParseFloat(value) {
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        /**
         * Initializes tab switching functionality.
         */
        function setupTabs() {
            const calculatorTabButton = document.getElementById('tab-calculator');
            const recorderTabButton = document.getElementById('tab-recorder');
            const calculatorContent = document.getElementById('content-calculator');
            const recorderContent = document.getElementById('content-recorder');

            const activateTab = (activeButton, inactiveButton, activeContent, inactiveContent) => {
                activeButton.classList.add('active');
                inactiveButton.classList.remove('active');
                activeContent.classList.remove('hidden');
                inactiveContent.classList.add('hidden');
            };

            calculatorTabButton.addEventListener('click', () => {
                activateTab(calculatorTabButton, recorderTabButton, calculatorContent, recorderContent);
            });

            recorderTabButton.addEventListener('click', () => {
                activateTab(recorderTabButton, calculatorTabButton, recorderContent, calculatorContent);
            });
        }

        /**
         * Setup menu navigation for SPA
         */
        function setupMenuNavigation() {
          const menuButtons = document.querySelectorAll('.menu-button');
          const contentContainer = document.getElementById('contentContainer');

          menuButtons.forEach(button => {
            button.addEventListener('click', () => {
              const menuId = button.getAttribute('data-menu-id');
              
              // Clear existing content
              contentContainer.innerHTML = '';

              // Load new content based on menuId
              if (menuId === 'home') {
                contentContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Welcome to the Trading Journal & Compound Calculator!</p>`;
              } else if (menuId === 'oee') {
                contentContainer.innerHTML = `<p class="text-center text-gray-500 py-4">OEE Content Coming Soon!</p>`;
              } else if (menuId === 'login') {
                contentContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Login Functionality Coming Soon!</p>`;
              }
            });
          });
        }

        // **********************************************
        // Trade Recording Logic (doPost)
        // **********************************************

        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
         * @param {number} index - Index ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ID ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)
         * @param {string} startBalanceValue - ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô
         * @returns {string} HTML string
         */
        function createTradeEntryHTML(index, startBalanceValue = '') {
            const accountOptions = MOCK_ACCOUNTS.map(acc => 
                `<option value="${acc['Account ID']}">${acc['‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ']} (${acc['Account ID']})</option>`
            ).join('');

            const assetOptions = MOCK_ASSETS.map(asset => 
                `<option value="${asset['Asset ID']}">${asset['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå']}</option>`
            ).join('');

            return `
            <div class="trade-entry-block p-4 border border-gray-300 rounded-lg shadow-sm bg-white" data-index="${index}">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-md font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î #${index + 1}</h3>
                    <button type="button" class="remove-entry-button text-red-500 hover:text-red-700 text-sm font-medium focus:outline-none ${index === 0 ? 'hidden' : ''}">
                        ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </button>
                </div>
                
                <!-- Account and Asset Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡∏£‡∏î:</label>
                        <select name="accountId" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm trade-input">
                            ${accountOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå:</label>
                        <select name="assetId" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm trade-input">
                            ${assetOptions}
                        </select>
                    </div>
                </div>

                <!-- Balance and Profit Input -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô (USD):</label>
                        <input type="number" name="startBalance" step="0.01" required 
                               value="${startBalanceValue}" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 bg-gray-50 trade-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (USD):</label>
                        <input type="number" name="dailyProfit" step="0.01" required value="" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 trade-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô (USD):</label>
                        <input type="text" name="endBalance" readonly value="" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm p-2 bg-blue-100 font-bold text-gray-800">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lot Size:</label>
                        <input type="number" name="lotSize" step="0.01" required value="0.01" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 trade-input">
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</label>
                    <textarea name="notes" rows="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 trade-input" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå, ‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î, ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"></textarea>
                </div>
            </div>
            `;
        }

        /**
         * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
         * @param {HTMLElement} entryBlock - ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
         */
        function updateBalances(entryBlock) {
            const startBalanceInput = entryBlock.querySelector('[name="startBalance"]');
            const dailyProfitInput = entryBlock.querySelector('[name="dailyProfit"]');
            const endBalanceInput = entryBlock.querySelector('[name="endBalance"]');

            const startBalance = safeParseFloat(startBalanceInput.value);
            const dailyProfit = safeParseFloat(dailyProfitInput.value);
            const endBalance = startBalance + dailyProfit;

            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï '‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô' ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            endBalanceInput.value = endBalance.toFixed(2);

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï '‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏±‡∏ô' ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            const nextEntryBlock = entryBlock.nextElementSibling;
            if (nextEntryBlock && nextEntryBlock.classList.contains('trade-entry-block')) {
                const nextStartBalanceInput = nextEntryBlock.querySelector('[name="startBalance"]');
                if (nextStartBalanceInput) {
                    nextStartBalanceInput.value = endBalance.toFixed(2);
                }
            }
        }

        /**
         * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏´‡∏°‡πà
         * @param {string} initialStartBalance - ‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ (‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
         */
        function addTradeEntry(initialStartBalance = '') {
            const container = document.getElementById('tradeEntriesContainer');
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            if (entryCounter > 0) {
                const lastEntry = container.lastElementChild;
                const lastEndBalanceInput = lastEntry ? lastEntry.querySelector('[name="endBalance"]') : null;
                initialStartBalance = lastEndBalanceInput ? lastEndBalanceInput.value : initialStartBalance;
            }

            const newEntryHTML = createTradeEntryHTML(entryCounter, initialStartBalance);
            container.insertAdjacentHTML('beforeend', newEntryHTML);
            const newEntryBlock = container.lastElementChild;

            // ‡∏ú‡∏π‡∏Å Event Listener
            newEntryBlock.querySelectorAll('.trade-input').forEach(input => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤
                input.addEventListener('input', () => updateBalances(newEntryBlock));
            });

            // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å)
            const removeButton = newEntryBlock.querySelector('.remove-entry-button');
            if (removeButton) {
                removeButton.addEventListener('click', () => {
                    newEntryBlock.remove();
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Balances ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
                    const nextEntry = container.firstElementChild;
                    if (nextEntry) {
                        updateBalances(nextEntry);
                    }
                });
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
            updateBalances(newEntryBlock);

            entryCounter++;
        }

        /**
         * ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á App Script ‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
         */
        async function postTradeData(event) {
            event.preventDefault();
            const submitButton = document.getElementById('submitButton');
            const statusMessage = document.getElementById('submissionStatus');
            const container = document.getElementById('tradeEntriesContainer');
            const tradeEntryBlocks = container.querySelectorAll('.trade-entry-block');
            
            if (tradeEntryBlocks.length === 0) {
                statusMessage.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                statusMessage.classList.remove('hidden', 'text-green-600');
                statusMessage.classList.add('text-red-500', 'bg-red-100');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å 0/${tradeEntryBlocks.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`;
            statusMessage.classList.add('hidden');

            let successfulSubmissions = 0;
            const errors = [];
            
            if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_WEB_APP_URL') {
                statusMessage.textContent = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô APPS_SCRIPT_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á";
                statusMessage.classList.remove('hidden', 'text-green-600');
                statusMessage.classList.add('text-red-500', 'bg-red-100');
                submitButton.disabled = false;
                submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                return;
            }

            for (let i = 0; i < tradeEntryBlocks.length; i++) {
                const block = tradeEntryBlocks[i];
                try {
                    // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const data = {
                        accountId: block.querySelector('[name="accountId"]').value,
                        assetId: block.querySelector('[name="assetId"]').value,
                        startBalance: block.querySelector('[name="startBalance"]').value,
                        dailyProfit: block.querySelector('[name="dailyProfit"]').value,
                        lotSize: block.querySelector('[name="lotSize"]').value,
                        notes: block.querySelector('[name="notes"]').value,
                    };

                    const urlSearchParams = new URLSearchParams(data);

                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: urlSearchParams, 
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        successfulSubmissions++;
                        // ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ)
                        block.style.borderColor = '#34D399'; // border-green-400
                    } else {
                        errors.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ #${i + 1}: ${result.message}`);
                        block.style.borderColor = '#EF4444'; // border-red-500
                    }

                } catch (error) {
                    errors.push(`‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ #${i + 1}: ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (${error.message})`);
                    block.style.borderColor = '#EF4444'; // border-red-500
                    console.error(`Error posting data for entry ${i + 1}:`, error);
                } finally {
                    submitButton.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${successfulSubmissions}/${tradeEntryBlocks.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`;
                }
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ
            if (errors.length === 0) {
                statusMessage.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${successfulSubmissions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£!`;
                statusMessage.classList.remove('hidden', 'text-red-500', 'bg-red-100');
                statusMessage.classList.add('text-green-600', 'bg-green-100');
                // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                container.innerHTML = '';
                entryCounter = 0;
                addTradeEntry(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            } else {
                statusMessage.textContent = `‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successfulSubmissions} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errors.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${errors.join(' | ')}`;
                statusMessage.classList.remove('hidden', 'text-green-600', 'bg-green-100');
                statusMessage.classList.add('text-yellow-600', 'bg-yellow-100');
            }
            
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        }
        
        // **********************************************
        // Compound Calculator Logic (Code from previous version)
        // **********************************************
        let compoundingChart = null; // Reference to the chart instance

        function generateYearlySummaryTable(initialCapitalUSD) {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ReferenceError ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        }
        
        function generateDailyTradingTable(initialCapitalUSD) {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ReferenceError ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á
        }

        function updateChartAndSummary() {
            const dailyRate = 0.01;
            const initialCapitalInput = document.getElementById('initialCapitalInput');
            const initialCapitalDisplay = document.getElementById('initialCapitalDisplay');
            const summaryInitialCapital = document.getElementById('summaryInitialCapital');
            const yearInput = document.getElementById('yearInput');
            const exchangeRateInput = document.getElementById('exchangeRateInput');
            const durationDisplay = document.getElementById('durationDisplay');
            const finalAmountElement = document.getElementById('finalAmount');
            const netProfitElement = document.getElementById('netProfit');
            const ctx = document.getElementById('compoundingChart').getContext('2d');
            const capitalWarning = document.getElementById('capitalWarning');

            const rawInitialCapital = parseFloat(initialCapitalInput.value);
            
            if (rawInitialCapital < 100) {
                capitalWarning.classList.remove('hidden');
            } else {
                capitalWarning.classList.add('hidden');
            }

            const initialCapitalUSD = Math.max(100, rawInitialCapital || 100);
            
            initialCapitalDisplay.textContent = `$${initialCapitalUSD.toFixed(2)}`;
            summaryInitialCapital.textContent = `$${initialCapitalUSD.toFixed(2)}`;
            
            const years = parseInt(yearInput.value) || 0;
            const totalDays = years * 365;
            const exchangeRate = parseFloat(exchangeRateInput.value) || 0;
            
            durationDisplay.textContent = `${years} ‡∏õ‡∏µ (${totalDays} ‡∏ß‡∏±‡∏ô)`;

            const labels = [];
            const dataPoints = [];
            let currentBalanceUSD = initialCapitalUSD;

            for (let day = 0; day <= totalDays; day++) {
                if (day % 30 === 0 || day === totalDays) {
                    const currentBalanceTHB = currentBalanceUSD * exchangeRate;
                    labels.push(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day}`);
                    dataPoints.push(parseFloat(currentBalanceTHB.toFixed(2)));
                }

                if (day < totalDays) {
                    currentBalanceUSD *= (1 + dailyRate);
                }
            }
            
            const finalAmountTHB = dataPoints[dataPoints.length - 1];
            const netProfitTHB = finalAmountTHB - (initialCapitalUSD * exchangeRate);

            finalAmountElement.textContent = `‡∏ø${finalAmountTHB.toLocaleString('th-TH', { minimumFractionDigits: 2 })}`;
            netProfitElement.textContent = `‡∏ø${netProfitTHB.toLocaleString('th-TH', { minimumFractionDigits: 2 })}`;

            if (compoundingChart) {
                compoundingChart.destroy();
            }

            compoundingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)',
                        data: dataPoints,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: 'start',
                        tension: 0.2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏ö‡∏ö‡∏ó‡∏ß‡∏µ‡∏Ñ‡∏π‡∏ì (Exponential Growth)',
                            font: { size: 16, weight: 'bold' },
                            color: '#374151'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)'
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', notation: 'compact', compactDisplay: 'short' }).format(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '‡∏ß‡∏±‡∏ô'
                            }
                        }
                    }
                });
            
            // Re-run table generation (even if hidden)
            generateYearlySummaryTable(initialCapitalUSD);
            generateDailyTradingTable(initialCapitalUSD);
        }
        
        // **********************************************
        // Authentication and User Management
        // **********************************************
        
        async function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                // Redirect to login if no token
                window.location.href = 'index.html';
                return false;
            }
            
            try {
                // Display user info
                const userData = JSON.parse(user);
                document.getElementById('userDisplayName').textContent = userData.fullName || userData.id;
                document.getElementById('userRole').textContent = `(${userData.role})`;
                
                // Fetch current balance
                await fetchCurrentBalance(token, userData.id);
                
                return true;
            } catch (error) {
                console.error('Authentication check failed:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                return false;
            }
        }
        
        async function fetchCurrentBalance(token, userId) {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getAccountSummary&token=${token}&accountId=${userId}`, {
                    method: 'GET'
                });
                
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    const balance = result.data.currentBalance || 0;
                    document.getElementById('currentBalance').textContent = `$${balance.toFixed(2)}`;
                } else {
                    document.getElementById('currentBalance').textContent = '$0.00';
                }
            } catch (error) {
                console.error('Error fetching balance:', error);
                document.getElementById('currentBalance').textContent = '$0.00';
            }
        }
        
        function logout() {
            const token = localStorage.getItem('token');
            
            // Call logout API (optional)
            if (token) {
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'logout',
                        token: token
                    })
                }).catch(error => console.error('Logout API error:', error));
            }
            
            // Clear local storage
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            // Redirect to login
            window.location.href = 'index.html';
        }
        
        // **********************************************
        // Initialization
        // **********************************************
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            const isAuthenticated = await checkAuthentication();
            if (!isAuthenticated) return;
            
            // Setup logout button
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            setupTabs();
            
            // Setup for Trade Recorder
            const addEntryButton = document.getElementById('addEntryButton');
            addEntryButton.addEventListener('click', () => addTradeEntry());
            
            // MUST show the first entry when the page loads
            addTradeEntry(); 

            // Set up event listener for Trade Form
            document.getElementById('tradeForm').addEventListener('submit', postTradeData);

            // Set up event listeners for Calculator
            const initialCapitalInput = document.getElementById('initialCapitalInput');
            const yearInput = document.getElementById('yearInput');
            const exchangeRateInput = document.getElementById('exchangeRateInput');
            
            initialCapitalInput.addEventListener('input', updateChartAndSummary);
            yearInput.addEventListener('input', updateChartAndSummary);
            exchangeRateInput.addEventListener('input', updateChartAndSummary);

            // Initial render for Calculator
            updateChartAndSummary();

            // Setup menu navigation
            setupMenuNavigation();
        });
    </script>
</body>
</html>
