<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Reset Password</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 800px;
            width: 100%;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-section .icon {
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }

        .result.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .workflow {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
        }

        .workflow h4 {
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workflow ol {
            margin-left: 20px;
        }

        .workflow li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pending { background-color: #ffc107; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }

        .api-info {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-left: 3px solid #667eea;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .test-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Reset Password</h1>
            <p>SAP-Style Password Reset Testing Tool</p>
        </div>

        <div class="content">
            <div class="workflow">
                <h4>üìã SAP-Style Password Reset Workflow</h4>
                <ol>
                    <li><strong>Step 1:</strong> User ‡∏™‡πà‡∏á email ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠ reset password</li>
                    <li><strong>Step 2:</strong> System ‡∏™‡∏£‡πâ‡∏≤‡∏á temporary password "Init4321"</li>
                    <li><strong>Step 3:</strong> ‡∏™‡πà‡∏á email notification ‡∏û‡∏£‡πâ‡∏≠‡∏° temporary password</li>
                    <li><strong>Step 4:</strong> User login ‡∏î‡πâ‡∏ß‡∏¢ temporary password</li>
                    <li><strong>Step 5:</strong> System ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password ‡πÉ‡∏´‡∏°‡πà</li>
                    <li><strong>Step 6:</strong> User ‡πÉ‡∏ä‡πâ password ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ login ‡∏ï‡πà‡∏≠‡πÑ‡∏õ</li>
                </ol>
            </div>

            <div class="api-info">
                <strong>API Endpoint:</strong> <span id="apiUrl">Loading...</span><br>
                <strong>Action:</strong> resetPassword<br>
                <strong>Method:</strong> POST<br>
                <strong>Content-Type:</strong> application/x-www-form-urlencoded
            </div>

            <!-- Step 1: Reset Password -->
            <div class="test-section">
                <h3>
                    <span class="icon">üîÑ</span>
                    Step 1: Reset Password Request
                </h3>
                <div class="form-group">
                    <label for="resetEmail">Email Address:</label>
                    <input type="email" id="resetEmail" placeholder="user@example.com" value="test@example.com">
                </div>
                <button class="btn" onclick="resetPassword()">
                    <span class="status-indicator status-pending"></span>
                    Reset Password
                </button>
                <button class="btn btn-secondary" onclick="clearResetResult()">Clear Result</button>
                <div id="resetResult" class="result" style="display: none;"></div>
            </div>

            <!-- Step 2: Login with Temporary Password -->
            <div class="test-section">
                <h3>
                    <span class="icon">üîë</span>
                    Step 2: Login with Temporary Password
                </h3>
                <div class="form-group">
                    <label for="tempUsername">Username (Email or EmpId):</label>
                    <input type="text" id="tempUsername" placeholder="user@example.com" value="test@example.com">
                </div>
                <div class="form-group">
                    <label for="tempPassword">Temporary Password:</label>
                    <input type="password" id="tempPassword" placeholder="Init4321" value="Init4321">
                </div>
                <button class="btn" onclick="loginWithTempPassword()">
                    <span class="status-indicator status-pending"></span>
                    Login with Temp Password
                </button>
                <button class="btn btn-secondary" onclick="clearTempLoginResult()">Clear Result</button>
                <div id="tempLoginResult" class="result" style="display: none;"></div>
            </div>

            <!-- Step 3: Change Password -->
            <div class="test-section">
                <h3>
                    <span class="icon">üîê</span>
                    Step 3: Change Password (Forced)
                </h3>
                <div class="form-group">
                    <label for="changeEmpId">Employee ID:</label>
                    <input type="text" id="changeEmpId" placeholder="EMP001" value="EMP001">
                </div>
                <div class="form-group">
                    <label for="changeCurrentPassword">Current Password:</label>
                    <input type="password" id="changeCurrentPassword" placeholder="Init4321" value="Init4321">
                </div>
                <div class="form-group">
                    <label for="changeNewPassword">New Password:</label>
                    <input type="password" id="changeNewPassword" placeholder="MyNewPassword123" value="MyNewPassword123">
                </div>
                <button class="btn" onclick="changePassword()">
                    <span class="status-indicator status-pending"></span>
                    Change Password
                </button>
                <button class="btn btn-secondary" onclick="clearChangeResult()">Clear Result</button>
                <div id="changeResult" class="result" style="display: none;"></div>
            </div>

            <!-- Step 4: Final Login Test -->
            <div class="test-section">
                <h3>
                    <span class="icon">üéØ</span>
                    Step 4: Final Login Test
                </h3>
                <div class="form-group">
                    <label for="finalUsername">Username:</label>
                    <input type="text" id="finalUsername" placeholder="user@example.com" value="test@example.com">
                </div>
                <div class="form-group">
                    <label for="finalPassword">New Password:</label>
                    <input type="password" id="finalPassword" placeholder="MyNewPassword123" value="MyNewPassword123">
                </div>
                <button class="btn" onclick="finalLogin()">
                    <span class="status-indicator status-pending"></span>
                    Final Login Test
                </button>
                <button class="btn btn-secondary" onclick="clearFinalResult()">Clear Result</button>
                <div id="finalResult" class="result" style="display: none;"></div>
            </div>

            <!-- Test All Steps -->
            <div class="test-section">
                <h3>
                    <span class="icon">üöÄ</span>
                    Complete Workflow Test
                </h3>
                <p>‡∏ó‡∏î‡∏™‡∏≠‡∏ö workflow ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10-15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
                <button class="btn" onclick="runCompleteWorkflow()">
                    <span class="status-indicator status-pending"></span>
                    Run Complete Workflow
                </button>
                <button class="btn btn-danger" onclick="clearAllResults()">Clear All Results</button>
                <div id="workflowResult" class="result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { APPS_SCRIPT_URL } from './js/config.js';
        
        // Make API URL available globally
        window.API_BASE = APPS_SCRIPT_URL;
        
        // Display API URL in the page
        document.getElementById('apiUrl').textContent = APPS_SCRIPT_URL;
        
        console.log('üîó API Base URL loaded:', APPS_SCRIPT_URL);
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let workflowStep = 0;

        // Utility functions
        function showResult(elementId, message, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            
            // Auto scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function formatResponse(response) {
            return JSON.stringify(response, null, 2);
        }

        function updateStatusIndicator(buttonElement, status) {
            const indicator = buttonElement.querySelector('.status-indicator');
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        // Step 1: Reset Password
        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            const button = event.target;
            
            if (!email) {
                showResult('resetResult', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà email address', 'error');
                return;
            }

            try {
                updateStatusIndicator(button, 'pending');
                showResult('resetResult', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á reset password...', 'info');
                
                const response = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'resetPassword',
                        email: email
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    updateStatusIndicator(button, 'success');
                    showResult('resetResult', 
                        `‚úÖ Reset password ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                        `Response:\n${formatResponse(result)}\n\n` +
                        `üìß Temporary password ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${email}\n` +
                        `üîë Temporary Password: Init4321\n\n` +
                        `üí° ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Step 2 ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    
                    // Auto-fill next step
                    document.getElementById('tempUsername').value = email;
                    document.getElementById('changeEmpId').value = result.empId || 'EMP001';
                    document.getElementById('finalUsername').value = email;
                } else {
                    updateStatusIndicator(button, 'error');
                    showResult('resetResult', 
                        `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n\n${formatResponse(result)}`, 'error');
                }
            } catch (error) {
                updateStatusIndicator(button, 'error');
                showResult('resetResult', 
                    `‚ùå Network Error:\n\n${error.message}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n- ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ internet\n- API URL ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\n- CORS settings`, 'error');
            }
        }

        // Step 2: Login with Temporary Password
        async function loginWithTempPassword() {
            const username = document.getElementById('tempUsername').value.trim();
            const password = document.getElementById('tempPassword').value.trim();
            const button = event.target;
            
            if (!username || !password) {
                showResult('tempLoginResult', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà username ‡πÅ‡∏•‡∏∞ password', 'error');
                return;
            }

            try {
                updateStatusIndicator(button, 'pending');
                showResult('tempLoginResult', 'üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á login...', 'info');
                
                const response = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    if (result.requirePasswordChange) {
                        updateStatusIndicator(button, 'success');
                        showResult('tempLoginResult', 
                            `‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üîÑ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password\n\n` +
                            `Response:\n${formatResponse(result)}\n\n` +
                            `‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n\n` +
                            `üí° ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Step 3 ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß`, 'warning');
                        
                        // Auto-fill change password form
                        if (result.user) {
                            document.getElementById('changeEmpId').value = result.user.empId || 'EMP001';
                            currentUser = result.user;
                        }
                    } else {
                        updateStatusIndicator(button, 'success');
                        showResult('tempLoginResult', 
                            `‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Normal login)\n\n${formatResponse(result)}`, 'success');
                    }
                } else {
                    updateStatusIndicator(button, 'error');
                    showResult('tempLoginResult', 
                        `‚ùå Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:\n\n${formatResponse(result)}`, 'error');
                }
            } catch (error) {
                updateStatusIndicator(button, 'error');
                showResult('tempLoginResult', 
                    `‚ùå Network Error:\n\n${error.message}`, 'error');
            }
        }

        // Step 3: Change Password
        async function changePassword() {
            const empId = document.getElementById('changeEmpId').value.trim();
            const currentPassword = document.getElementById('changeCurrentPassword').value.trim();
            const newPassword = document.getElementById('changeNewPassword').value.trim();
            const button = event.target;
            
            if (!empId || !currentPassword || !newPassword) {
                showResult('changeResult', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showResult('changeResult', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
                return;
            }

            try {
                updateStatusIndicator(button, 'pending');
                showResult('changeResult', 'üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password...', 'info');
                
                const response = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'changePassword',
                        empId: empId,
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    updateStatusIndicator(button, 'success');
                    showResult('changeResult', 
                        `‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                        `Response:\n${formatResponse(result)}\n\n` +
                        `üéØ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ login ‡∏î‡πâ‡∏ß‡∏¢ password ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß\n\n` +
                        `üí° ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Step 4 ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    
                    // Auto-fill final login form
                    document.getElementById('finalPassword').value = newPassword;
                } else {
                    updateStatusIndicator(button, 'error');
                    showResult('changeResult', 
                        `‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:\n\n${formatResponse(result)}`, 'error');
                }
            } catch (error) {
                updateStatusIndicator(button, 'error');
                showResult('changeResult', 
                    `‚ùå Network Error:\n\n${error.message}`, 'error');
            }
        }

        // Step 4: Final Login
        async function finalLogin() {
            const username = document.getElementById('finalUsername').value.trim();
            const password = document.getElementById('finalPassword').value.trim();
            const button = event.target;
            
            if (!username || !password) {
                showResult('finalResult', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà username ‡πÅ‡∏•‡∏∞ password', 'error');
                return;
            }

            try {
                updateStatusIndicator(button, 'pending');
                showResult('finalResult', 'üéØ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö login ‡∏î‡πâ‡∏ß‡∏¢ password ‡πÉ‡∏´‡∏°‡πà...', 'info');
                
                const response = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    if (result.requirePasswordChange) {
                        updateStatusIndicator(button, 'error');
                        showResult('finalResult', 
                            `‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password ‡∏≠‡∏¢‡∏π‡πà\n\n${formatResponse(result)}\n\n` +
                            `‚ùì ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô Step 3`, 'warning');
                    } else {
                        updateStatusIndicator(button, 'success');
                        showResult('finalResult', 
                            `üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Login ‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß\n\n` +
                            `Response:\n${formatResponse(result)}\n\n` +
                            `‚úÖ SAP-Style Password Reset Workflow ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!\n\n` +
                            `üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏ß‡πâ`, 'success');
                    }
                } else {
                    updateStatusIndicator(button, 'error');
                    showResult('finalResult', 
                        `‚ùå Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:\n\n${formatResponse(result)}`, 'error');
                }
            } catch (error) {
                updateStatusIndicator(button, 'error');
                showResult('finalResult', 
                    `‚ùå Network Error:\n\n${error.message}`, 'error');
            }
        }

        // Complete Workflow Test
        async function runCompleteWorkflow() {
            const button = event.target;
            const email = document.getElementById('resetEmail').value.trim() || 'test@example.com';
            const newPassword = document.getElementById('changeNewPassword').value.trim() || 'MyNewPassword123';
            
            updateStatusIndicator(button, 'pending');
            showResult('workflowResult', 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö Complete Workflow...\n\n', 'info');
            
            let workflowLog = 'üìã SAP-Style Password Reset Workflow Test\n';
            workflowLog += '='.repeat(50) + '\n\n';
            
            try {
                // Step 1: Reset Password
                workflowLog += 'üîÑ Step 1: Reset Password\n';
                workflowLog += `Email: ${email}\n`;
                
                const resetResponse = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'resetPassword', email: email })
                });
                const resetResult = await resetResponse.json();
                
                if (resetResult.status === 'success') {
                    workflowLog += '‚úÖ Reset ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n';
                    workflowLog += `EmpId: ${resetResult.empId || 'N/A'}\n\n`;
                } else {
                    workflowLog += '‚ùå Reset ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß\n';
                    workflowLog += `Error: ${resetResult.message}\n\n`;
                    showResult('workflowResult', workflowLog, 'error');
                    updateStatusIndicator(button, 'error');
                    return;
                }

                // Wait 2 seconds
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 2: Login with Temp Password
                workflowLog += 'üîë Step 2: Login with Temporary Password\n';
                workflowLog += `Username: ${email}\n`;
                workflowLog += `Password: Init4321\n`;
                
                const tempLoginResponse = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'login', username: email, password: 'Init4321' })
                });
                const tempLoginResult = await tempLoginResponse.json();
                
                if (tempLoginResult.status === 'success' && tempLoginResult.requirePasswordChange) {
                    workflowLog += '‚úÖ Temp Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (requirePasswordChange: true)\n';
                    workflowLog += `User: ${tempLoginResult.user?.empId || 'N/A'}\n\n`;
                } else {
                    workflowLog += '‚ùå Temp Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password\n';
                    workflowLog += `Response: ${JSON.stringify(tempLoginResult, null, 2)}\n\n`;
                    showResult('workflowResult', workflowLog, 'error');
                    updateStatusIndicator(button, 'error');
                    return;
                }

                // Wait 2 seconds
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 3: Change Password
                workflowLog += 'üîê Step 3: Change Password\n';
                workflowLog += `EmpId: ${resetResult.empId || 'EMP001'}\n`;
                workflowLog += `Current: Init4321\n`;
                workflowLog += `New: ${newPassword}\n`;
                
                const changeResponse = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'changePassword',
                        empId: resetResult.empId || 'EMP001',
                        currentPassword: 'Init4321',
                        newPassword: newPassword
                    })
                });
                const changeResult = await changeResponse.json();
                
                if (changeResult.status === 'success') {
                    workflowLog += '‚úÖ Change Password ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n\n';
                } else {
                    workflowLog += '‚ùå Change Password ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß\n';
                    workflowLog += `Error: ${changeResult.message}\n\n`;
                    showResult('workflowResult', workflowLog, 'error');
                    updateStatusIndicator(button, 'error');
                    return;
                }

                // Wait 2 seconds
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 4: Final Login
                workflowLog += 'üéØ Step 4: Final Login Test\n';
                workflowLog += `Username: ${email}\n`;
                workflowLog += `Password: ${newPassword}\n`;
                
                const finalResponse = await fetch(window.API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'login', username: email, password: newPassword })
                });
                const finalResult = await finalResponse.json();
                
                if (finalResult.status === 'success' && !finalResult.requirePasswordChange) {
                    workflowLog += '‚úÖ Final Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Normal login)\n\n';
                    workflowLog += 'üéâ SAP-Style Password Reset Workflow ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!\n';
                    workflowLog += '‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏ß‡πâ\n\n';
                    workflowLog += 'üìä Summary:\n';
                    workflowLog += '- Reset Password: ‚úÖ\n';
                    workflowLog += '- Temp Login: ‚úÖ\n';
                    workflowLog += '- Change Password: ‚úÖ\n';
                    workflowLog += '- Final Login: ‚úÖ\n';
                    
                    updateStatusIndicator(button, 'success');
                    showResult('workflowResult', workflowLog, 'success');
                } else {
                    workflowLog += '‚ùå Final Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô password\n';
                    workflowLog += `Response: ${JSON.stringify(finalResult, null, 2)}\n\n`;
                    updateStatusIndicator(button, 'error');
                    showResult('workflowResult', workflowLog, 'error');
                }

            } catch (error) {
                workflowLog += `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö:\n${error.message}\n`;
                updateStatusIndicator(button, 'error');
                showResult('workflowResult', workflowLog, 'error');
            }
        }

        // Clear result functions
        function clearResetResult() { 
            document.getElementById('resetResult').style.display = 'none'; 
        }
        function clearTempLoginResult() { 
            document.getElementById('tempLoginResult').style.display = 'none'; 
        }
        function clearChangeResult() { 
            document.getElementById('changeResult').style.display = 'none'; 
        }
        function clearFinalResult() { 
            document.getElementById('finalResult').style.display = 'none'; 
        }
        function clearAllResults() {
            ['resetResult', 'tempLoginResult', 'changeResult', 'finalResult', 'workflowResult'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // Reset all status indicators
            document.querySelectorAll('.status-indicator').forEach(indicator => {
                indicator.className = 'status-indicator status-pending';
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Password Reset Test Page Loaded');
            console.log('üîó API Base URL:', window.API_BASE);
            
            // Fill default values
            document.getElementById('resetEmail').value = 'test@example.com';
            document.getElementById('tempUsername').value = 'test@example.com';
            document.getElementById('finalUsername').value = 'test@example.com';
            document.getElementById('changeEmpId').value = 'EMP001';
            document.getElementById('changeNewPassword').value = 'MyNewPassword123';
            document.getElementById('finalPassword').value = 'MyNewPassword123';
        });
    </script>
</body>
</html>