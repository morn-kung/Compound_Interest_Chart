<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test NEW Deployment</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üéâ Test NEW Deployment</h1>
        
        <div class="bg-green-100 border-l-4 border-green-500 p-4 mb-6">
            <h2 class="font-semibold">‚úÖ NEW Deployment Created!</h2>
            <p class="text-sm mt-1">URL: AKfycbyD5Ps2g6Aee0On9jSeuy4Qsr86FPydGgrjVwZ6OyoOJZrvjjkqf7IMYgFJRdSKb9-3</p>
            <p class="text-sm">Config.js updated with new URL</p>
        </div>
        
        <!-- Quick Tests -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">‚ö° Quick Tests</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <button onclick="testDebugPOST()" class="bg-yellow-600 text-white px-4 py-3 rounded hover:bg-yellow-700 font-bold">
                    üîç debugPOST
                </button>
                <button onclick="testDebugLogin()" class="bg-purple-600 text-white px-4 py-3 rounded hover:bg-purple-700 font-bold">
                    üêõ debugLogin
                </button>
                <button onclick="testPOSTLogin()" class="bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700 font-bold">
                    üî• POST Login
                </button>
                <button onclick="testPublicEndpoint()" class="bg-blue-600 text-white px-4 py-3 rounded hover:bg-blue-700">
                    üîì Public Endpoint
                </button>
                <button onclick="testAll()" class="bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700 font-bold">
                    üöÄ Test All
                </button>
            </div>
        </div>
        
        <!-- Credentials -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">üîë Test Credentials</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Username:</label>
                    <input type="text" id="username" value="4498" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password:</label>
                    <input type="text" id="password" value="likit.se4498" class="w-full border rounded px-3 py-2">
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">üìä Test Results</h2>
            <div id="results" class="bg-gray-50 p-4 rounded text-xs font-mono h-80 overflow-y-auto whitespace-pre">
Ready to test NEW deployment...
            </div>
        </div>
        
        <!-- Success Banner -->
        <div id="successBanner" class="hidden bg-green-500 text-white p-6 rounded-lg shadow mt-6 text-center">
            <h2 class="text-2xl font-bold mb-2">üéâ POST LOGIN SUCCESS!</h2>
            <p class="text-lg">The issue is now FIXED! You can use the main application.</p>
            <div class="mt-4">
                <button onclick="openMainApp()" class="bg-white text-green-500 px-6 py-2 rounded font-bold hover:bg-gray-100">
                    üöÄ Open Main Application
                </button>
            </div>
        </div>
    </div>

    <script>
        // Import the new URL from config.js
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwQZdkrjEUpRvclc4IRDoplmeh33inRD5oKoYWeVPniw6GvjEuEWUzGHjQlSPHhqjqu/exec';
        
        function addResult(title, data, isSuccess = false) {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const content = `[${timestamp}] ${title}:\n${JSON.stringify(data, null, 2)}\n${'='.repeat(60)}\n\n`;
            resultsDiv.textContent = content + resultsDiv.textContent;
            
            if (isSuccess) {
                document.getElementById('successBanner').classList.remove('hidden');
            }
        }
        
        // Test debugPOST endpoint
        async function testDebugPOST() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'debugPOST',
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'debug') {
                    addResult('‚úÖ debugPOST SUCCESS', {
                        status: 'NEW DEPLOYMENT WORKING!',
                        extractionTest: data.debug?.extractionTest,
                        message: 'Parameter extraction is working correctly'
                    });
                } else if (data.message && data.message.includes('accountId, assetId')) {
                    addResult('‚ùå debugPOST OLD VERSION', {
                        status: 'Still using old deployment',
                        message: data.message,
                        solution: 'Wait a few minutes for propagation'
                    });
                } else {
                    addResult('‚ö†Ô∏è debugPOST UNEXPECTED', data);
                }
                
            } catch (error) {
                addResult('üí• debugPOST ERROR', { error: error.message });
            }
        }
        
        // Test debugLogin endpoint
        async function testDebugLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'debugLogin',
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'debug') {
                    // Show step-by-step results
                    const stepResults = data.results;
                    let statusEmoji = 'ÔøΩ';
                    let statusMsg = 'Debug Analysis';
                    
                    if (stepResults.step1_userFound && stepResults.step2_passwordMatch && stepResults.step3_fullAuth) {
                        statusEmoji = 'üéâ';
                        statusMsg = 'ALL STEPS PASSED!';
                    } else if (!stepResults.step1_userFound) {
                        statusEmoji = '‚ùå';
                        statusMsg = 'USER NOT FOUND';
                    } else if (!stepResults.step2_passwordMatch) {
                        statusEmoji = '‚ùå';
                        statusMsg = 'PASSWORD INCORRECT';
                    } else if (!stepResults.step3_fullAuth) {
                        statusEmoji = '‚ö†Ô∏è';
                        statusMsg = 'AUTH FUNCTION ISSUE';
                    }
                    
                    addResult(`${statusEmoji} Step-by-Step Debug`, {
                        status: statusMsg,
                        step1_userFound: stepResults.step1_userFound ? '‚úÖ PASS' : '‚ùå FAIL',
                        step2_passwordMatch: stepResults.step2_passwordMatch ? '‚úÖ PASS' : '‚ùå FAIL', 
                        step3_fullAuth: stepResults.step3_fullAuth ? '‚úÖ PASS' : '‚ùå FAIL',
                        userInfo: data.details?.userInfo,
                        hashComparison: data.details?.hashComparison,
                        logs: data.logs
                    });
                    
                    // If all steps pass, we found the issue!
                    if (stepResults.step1_userFound && stepResults.step2_passwordMatch && stepResults.step3_fullAuth) {
                        addResult('üéâ AUTHENTICATION WORKS!', {
                            status: 'Problem solved in debug mode',
                            message: 'Regular login endpoint has different issue',
                            solution: 'Check regular login vs debug login differences'
                        }, true);
                    }
                } else {
                    addResult('‚ö†Ô∏è debugLogin UNEXPECTED', data);
                }
                
            } catch (error) {
                addResult('üí• debugLogin ERROR', { error: error.message });
            }
        }
        
        // Test POST Login
        async function testPOSTLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'login',
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    addResult('üéâ POST LOGIN SUCCESS!', {
                        status: 'PROBLEM SOLVED!',
                        user: data.user?.name,
                        token: data.token ? 'Generated' : 'Not generated',
                        message: 'POST login is now working perfectly!'
                    }, true);
                    
                    // Store credentials for main app
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    
                } else {
                    addResult('‚ùå POST Login Still Failing', {
                        status: 'Still not working',
                        message: data.message,
                        debug: data.debug || 'No debug info',
                        suggestion: 'Check if new deployment propagated'
                    });
                }
                
            } catch (error) {
                addResult('üí• POST Login ERROR', { error: error.message });
            }
        }
        
        // Test public endpoint
        async function testPublicEndpoint() {
            try {
                const response = await fetch(`${GAS_URL}?action=testGetUserData`);
                const data = await response.json();
                
                if (data.users && Array.isArray(data.users)) {
                    addResult('‚úÖ Public Endpoint Working', {
                        status: 'NEW DEPLOYMENT CONFIRMED',
                        usersFound: data.users.length,
                        message: 'publicEndpoints array is working'
                    });
                } else if (data.status === 'error' && data.message.includes('Token is required')) {
                    addResult('‚ùå Public Endpoint Auth Required', {
                        status: 'Old deployment still active',
                        message: 'Wait for propagation or try hard refresh'
                    });
                } else {
                    addResult('‚ö†Ô∏è Public Endpoint Unexpected', data);
                }
                
            } catch (error) {
                addResult('üí• Public Endpoint ERROR', { error: error.message });
            }
        }
        
        // Test all
        async function testAll() {
            addResult('üöÄ Starting Comprehensive Test', { 
                newURL: GAS_URL,
                message: 'Testing all endpoints with new deployment'
            });
            
            await testPublicEndpoint();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDebugPOST();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testPOSTLogin();
            
            addResult('‚úÖ Comprehensive Test Complete', {
                message: 'Check results above for final status',
                nextStep: 'If POST login works, problem is solved!'
            });
        }
        
        // Open main application
        function openMainApp() {
            window.open('/frontend/index.html', '_blank');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addResult('üéâ NEW Deployment Test Ready', {
                newURL: GAS_URL,
                oldURL: 'AKfycbzl0_MJ047GyERwOy3dJ-yEUPFmNIUVwkWdxva6Z0Fttgjj_VI73HqzzJueGjb2V4Bt',
                change: 'URL updated in config.js',
                expectation: 'debugPOST and POST login should now work'
            });
        });
    </script>
</body>
</html>