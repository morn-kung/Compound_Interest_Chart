// Simple Response Helper with CORS support - Updated Oct 3, 2025 for Version 28
function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With',
      'Access-Control-Max-Age': '86400',
      'Access-Control-Allow-Credentials': 'false'
    });
}

/**
 * Handle OPTIONS requests for CORS preflight
 * @param {Object} e - Event object
 * @returns {GoogleAppsScript.Content.TextOutput} Empty response with CORS headers
 */
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With',
      'Access-Control-Max-Age': '86400',
      'Access-Control-Allow-Credentials': 'false'
    });
}

// Enhanced Response Helper using standardized patterns with CORS support
function createApiResponse(data) {
  // If data is already a standardized response, use it directly
  if (data && (data.status === 'success' || data.status === 'error' || data.status === 'validation_error')) {
    return createResponse(data);
  }
  
  // Otherwise, wrap in success response
  return createResponse(createSuccessResponse(data));
}

function testLogin(empId, password) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('user');
  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  console.log('Headers:', headers);

  // Fallback for CONFIG.COLUMNS if not loaded
  let empIdIndex, passwordIndex, fullNameIndex, emailIndex;
  
  if (typeof CONFIG !== 'undefined' && CONFIG.COLUMNS && CONFIG.COLUMNS.user) {
    empIdIndex = CONFIG.COLUMNS.user.EmpId;
    passwordIndex = CONFIG.COLUMNS.user.password;
    fullNameIndex = CONFIG.COLUMNS.user.FullNameTH;
    emailIndex = CONFIG.COLUMNS.user.Email;
  } else {
    // Fallback to indexOf
    empIdIndex = headers.indexOf('EmpId');
    passwordIndex = headers.indexOf('password');
    fullNameIndex = headers.indexOf('FullNameTH');
    emailIndex = headers.indexOf('Email');
  }

  // Find user by empId
  const userRow = data.find(row => String(row[empIdIndex]) === String(empId));
  if (!userRow) {
    return {
      status: 'error',
      message: 'User not found',
    };
  }

  // Verify password
  const passwordHash = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password)
    .map(b => (b < 0 ? b + 256 : b).toString(16).padStart(2, '0'))
    .join('');

  console.log('Input Password Hash:', passwordHash);
  console.log('Stored Password Hash:', String(userRow[passwordIndex]));

  if (String(userRow[passwordIndex]) !== String(passwordHash)) {
    return {
      status: 'error',
      message: 'Invalid password',
    };
  }

  // Return user info on success
  return {
    status: 'success',
    message: 'Login successful',
    user: {
      empId: userRow[empIdIndex],
      fullName: userRow[fullNameIndex],
      email: userRow[emailIndex],
    },
  };
}

// Authentication verification function
function verifyAuthentication(token) {
  // For this demo, we'll check if token exists and starts with 'user_'
  // In production, you should implement proper JWT or session management
  if (!token) {
    return { isValid: false, error: 'Authentication token is required' };
  }
  
  // Simple token validation (in production, use proper token verification)
  if (typeof token === 'string' && token.length > 10) {
    return { isValid: true, empId: '892' }; // Mock user for demo
  }
  
  return { isValid: false, error: 'Invalid authentication token' };
}

// Generate publicEndpoints dynamically (requires Services_get.js)
// Use lazy loading to avoid initialization issues
function getPublicEndpoints() {
  try {
    return generatePublicEndpoints();
  } catch (error) {
    // Fallback to basic endpoints if dynamic generation fails
    Logger.log('Failed to generate dynamic endpoints, using fallback: ' + error.message);
    return [
      'testlogin',
      'login',
      'changePassword',
      'resetPassword', 
      'logout',
      'getAdminforDashboard',
      'getOEEDailyData',
      'getRecentDashboards',
      'getAdminData',
      'getDailyChartSummary',
      'getRecentDaily'
    ];
  }
}

// Remove doOptions - not needed based on working code

// Handle CORS preflight requests
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With',
      'Access-Control-Max-Age': '86400',
      'Access-Control-Allow-Credentials': 'false'
    });
}

/**
 * Handles GET requests from frontend
 * @param {Object} e - Event object containing request parameters
 * @returns {GoogleAppsScript.Content.TextOutput} JSON response with CORS headers
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    
    // Route different actions
    switch (action) {
      case 'getOEEData':
        var result = getOEEDailyData();
        return createResponse(result);
        
      case 'getOEEDataV3':
        var result = getOEEDailyDataV3();
        return createResponse(result);
        
      case 'getRecentDashboards':
        var result = getRecentDashboardsService();
        return createResponse(result);
      
      case 'testConnection':
        return createResponse({
          status: 'success',
          message: 'Connection successful',
          timestamp: new Date().toISOString(),
          server: 'Google Apps Script'
        });
        
      default:
        return createResponse({
          status: 'error',
          message: 'Invalid action parameter',
          availableActions: ['getOEEData', 'getOEEDataV3', 'getRecentDashboards', 'testConnection']
        });
    }
    
  } catch (error) {
    Logger.log('Error in doGet: ' + error.toString());
    return createResponse({
      status: 'error',
      message: 'Internal server error: ' + error.message,
      timestamp: new Date().toISOString()
    });
  }
}

// Fixed doPost with consistent parameter handling
/**
 * Handles POST requests from frontend
 * @param {Object} e - Event object containing request data
 * @returns {GoogleAppsScript.Content.TextOutput} JSON response with CORS headers
 */
function doPost(e) {
  try {
    // Parse the request
    var data = null;
    
    if (e.postData && e.postData.contents) {
      try {
        data = JSON.parse(e.postData.contents);
      } catch (parseError) {
        return createResponse({
          status: 'error',
          message: 'Invalid JSON in request body',
          error: parseError.message
        });
      }
    } else {
      return createResponse({
        status: 'error',
        message: 'No data provided in POST request'
      });
    }
    
    const action = data.action;
    
    // Route different actions
    switch (action) {
      case 'createDashboard':
        var result = createDashboardService(data);
        return createResponse(result);
        
      case 'updateDashboard':
        var result = updateDashboardService(data);
        return createResponse(result);
        
      case 'testLogin':
        var result = testLogin(data.empId, data.password);
        return createResponse(result);
        
      default:
        return createResponse({
          status: 'error',
          message: 'Invalid action parameter',
          availableActions: ['createDashboard', 'updateDashboard', 'testLogin']
        });
    }
    
  } catch (error) {
    Logger.log('Error in doPost: ' + error.toString());
    return createResponse({
      status: 'error',
      message: 'Internal server error: ' + error.message,
      timestamp: new Date().toISOString()
    });
  }
}

/*
==============================================================================
üö® CORS TROUBLESHOOTING GUIDE - ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS
==============================================================================

üìã ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î CORS ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ:

1. üî¥ CRITICAL: doOptions() ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (2 functions!)
   - ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 18-28: function doOptions() ‡πÅ‡∏£‡∏Å
   - ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 141-151: function doOptions() ‡∏ã‡πâ‡∏≥ (Google Apps Script ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î)
   
   ‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: GAS ‡∏à‡∏∞‡πÉ‡∏ä‡πâ function ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ CORS headers ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
   ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏Å‡πá‡∏ö doOptions() ‡πÅ‡∏Ñ‡πà 1 function ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

2. ‚ö†Ô∏è CORS Headers ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
   ‚ùå ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:
   'Access-Control-Allow-Headers': 'Content-Type, Authorization, X-Requested-With'
   
   ‚úÖ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô:
   'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept, Authorization'
   'Vary': 'Origin'  // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ browser cache CORS ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

3. üîÑ Response Functions ‡πÑ‡∏°‡πà Consistent
   - ‡πÉ‡∏ä‡πâ createResponse() ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡πà
   - ‡πÉ‡∏ä‡πâ createApiResponse() ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡πà
   - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ CORS headers ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å response

4. üí• Error Handling ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î error ‡πÉ‡∏ô business logic ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ CORS headers ‡∏´‡∏≤‡∏¢
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ try-catch ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å response

==============================================================================
üéØ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥):

1. ‡∏•‡∏ö doOptions() ‡∏ã‡πâ‡∏≥ - ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß:

function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept, Authorization',
      'Access-Control-Max-Age': '86400',
      'Access-Control-Allow-Credentials': 'false',
      'Vary': 'Origin',  // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ!
      'Cache-Control': 'no-cache, no-store, must-revalidate'
    });
}

2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Unified Response Function:

function createCORSResponse(data, statusCode = 200) {
  const response = {
    status: statusCode >= 400 ? 'error' : 'success',
    data: data,
    timestamp: new Date().toISOString()
  };

  return ContentService.createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept, Authorization',
      'Access-Control-Max-Age': '86400',
      'Access-Control-Allow-Credentials': 'false',
      'Vary': 'Origin',
      'Cache-Control': 'no-cache, no-store, must-revalidate'
    });
}

3. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å createResponse() ‡πÅ‡∏•‡∏∞ createApiResponse() ‡∏î‡πâ‡∏ß‡∏¢ createCORSResponse()

4. ‡πÄ‡∏û‡∏¥‡πà‡∏° proper error handling:

function doGet(e) {
  try {
    // existing logic...
    return createCORSResponse(result);
  } catch (error) {
    console.error('doGet Error:', error);
    return createCORSResponse({
      error: 'Internal server error',
      message: error.message
    }, 500);
  }
}

==============================================================================
üß™ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö CORS:

1. ‡πÄ‡∏õ‡∏¥‡∏î Browser Developer Tools (F12)
2. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Console tab
3. ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ:

fetch('YOUR_GAS_WEB_APP_URL', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    action: 'testConnection'
  })
})
.then(response => {
  console.log('Response Headers:', response.headers);
  return response.json();
})
.then(data => console.log('‚úÖ CORS Success:', data))
.catch(error => console.error('‚ùå CORS Error:', error));

4. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ CORS error ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!

==============================================================================
üìä ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ CORS ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:

‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ error "blocked by CORS policy" ‡πÉ‡∏ô console
‚úÖ ‡πÄ‡∏´‡πá‡∏ô Access-Control-* headers ‡πÉ‡∏ô Network tab
‚úÖ OPTIONS request (preflight) return status 200
‚úÖ ‡∏ó‡∏∏‡∏Å API call ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å frontend ‡πÑ‡∏î‡πâ

==============================================================================
‚ö° Quick Fix Checklist:

‚ñ° ‡∏•‡∏ö doOptions() ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 1 function)
‚ñ° ‡πÄ‡∏û‡∏¥‡πà‡∏° 'Vary': 'Origin' header
‚ñ° ‡πÉ‡∏ä‡πâ function ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å response  
‚ñ° ‡πÄ‡∏û‡∏¥‡πà‡∏° try-catch ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
‚ñ° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ fetch() ‡πÉ‡∏ô browser console

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß CORS error ‡∏Ñ‡∏ß‡∏£‡∏´‡∏≤‡∏¢‡πÑ‡∏õ! üéâ
==============================================================================
*/
